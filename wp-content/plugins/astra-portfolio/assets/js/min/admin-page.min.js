var AstraPortfolioAjaxQueue=function(){var e=[];return{add:function(o){e.push(o)},remove:function(o){-1<jQuery.inArray(o,e)&&e.splice($.inArray(o,e),1)},run:function(){var o,t=this;e.length?(o=e[0].complete,e[0].complete=function(){"function"==typeof o&&o(),e.shift(),t.run.apply(t,[])},jQuery.ajax(e[0])):t.tid=setTimeout(function(){t.run.apply(t,[])},1e3)},stop:function(){e=[],console.log("requests",e),clearTimeout(this.tid)},_log:function(o,t){var e=(new Date).toLocaleTimeString();"object"==typeof o?console.log(o):console.log(o+" "+e)}}}();!function(u){AstraPortfolioAdminPage={init:function(){this._bind()},_bind:function(){u(document).on("click",".astra-portfolio-sync-library",AstraPortfolioAdminPage._sync_sites),u(document).on("astra-portfolio-process-all-import",AstraPortfolioAdminPage.process_all_import)},process_all_import:function(){var s=u(".astra-portfolio-sync-library");s.text("Generating Import List.."),u.ajax({url:AstraPortfolioAdminPageVars.ajax_url,type:"POST",data:{action:"astra-portfolio-get-all-data"},beforeSend:function(){console.log("Get all data..")}}).fail(function(o){console.log(o,"error")}).done(function(o){if(console.log("ALL SITES DATA 100+"),console.log(o),o.success){var t=o.data,e=parseInt(Object.keys(t).length)||0;if(console.log("Sites",t),console.log("Total Sites",e),e){AstraPortfolioAjaxQueue.stop();var a=1;for(site_id in t)console.log(site_id),AstraPortfolioAjaxQueue.add({url:AstraPortfolioAdminPageVars.ajax_url,type:"POST",data:{action:"astra-portfolio-import-single-site",site_id:site_id,site_data:t[site_id]},success:function(o){s.text("Site "+a+" of "+e),console.log(o),console.log(a,"New Site ",a," of ",e," Sites"),a===e?(s.text("Updating latest checksums."),u.ajax({url:AstraPortfolioAdminPageVars.ajax_url,type:"POST",data:{action:"astra-portfolio-checksums-update",_ajax_nonce:AstraPortfolioAdminPageVars._ajax_nonce}}).done(function(o){o.success&&(console.log(o),console.log("Complete..."),s.text("Imported "+e+" sites. Refreshing.."),setTimeout(function(){window.location=AstraPortfolioAdminPageVars.settings_page_url},3e3))})):a++}});AstraPortfolioAjaxQueue.run()}else s.removeClass("updating-message").text("Imported All Sites..")}else console.log(o.data)})},_sync_sites:function(o){o.preventDefault();var t=u(".astra-portfolio-sync-library");if(!t.hasClass("updating-message")){t.addClass("updating-message"),t.text("Checking Updates..");var e=u("#astra-portfolio-settings"),a=e.find('input[name="tab_slug"]').val()||"",s=e.find('input[name="other-categories"]:checked').val()||!1,r=e.find('input[name="categories"]:checked').val()||!1,i=e.find('input[name="show-search"]:checked').val()||!1,n=e.find('select[name="page-builder"] option:selected').attr("data-value")||"",l=e.find('select[name="page-builder"]').val()||"",c=e.find('input[name="responsive-button"]:checked').val()||!1;t.text("Saving Settings.."),u.ajax({url:AstraPortfolioAdminPageVars.ajax_url,type:"POST",data:{action:"astra-portfolio-save-settings",tab_slug:a,"other-categories":s,categories:r,"show-search":i,"page-builder":l,"responsive-button":c,_ajax_nonce:AstraPortfolioAdminPageVars._ajax_nonce}}).done(function(o){console.log(o),t.text("Settings Saved."),u.ajax({url:AstraPortfolioAdminPageVars.ajax_url,type:"POST",data:{action:"astra-portfolio-checksums-check",_ajax_nonce:AstraPortfolioAdminPageVars._ajax_nonce}}).done(function(o){if(console.log(o),o.success){if("batch"===AstraPortfolioAdminPageVars.sync_type)return u(".astra-portfolio-notice.notice-success").remove(),t.text("Importing.."),t.addClass("is-disabled"),t.removeClass("updating-message"),void u(AstraPortfolioAdminPageVars.batch_started_notice).insertAfter(u("#astra-portfolio-menu-page > h1"));t.text("Importing Categories.."),u.ajax({url:ajaxurl,type:"POST",data:{action:"astra_portfolio_import_term",new_taxonomy:"astra-portfolio-categories",taxonomy:"astra-site-category",import_status_string:"Importing Categories.."}}).done(function(o){console.log(o),t.text("Categories Imported Successfully."),t.text("Importing Other Categories.."),u.ajax({url:ajaxurl,type:"POST",data:{action:"astra_portfolio_import_term",new_taxonomy:"astra-portfolio-other-categories",taxonomy:"astra-site-page-builder",import_status_string:"Importing Other Categories.."}}).done(function(o){console.log(o),t.text("Other Categories Imported Successfully."),t.text("Getting All Sites.."),u.ajax({url:AstraPortfolioAdminPageVars.ajax_url,type:"POST",data:{action:"astra-portfolio-get-request-count",page_builder:n},beforeSend:function(){console.log("Get Total Sits..")}}).fail(function(o){console.log(o,"error")}).done(function(o){if(o.success){var t=o.data.total_requests;console.log("Total Pages: ",t);var e=1;for(page=1;page<=t;page++)console.log("Added in queue "+page),AstraPortfolioAjaxQueue.add({url:AstraPortfolioAdminPageVars.ajax_url,type:"POST",data:{action:"astra-portfolio-import-sites",page_no:e,page_builder:n},success:function(o){console.log(o),console.log("Total Pages ",t," page ",e),e===t&&u(document).trigger("astra-portfolio-process-all-import"),e++}});AstraPortfolioAjaxQueue.run()}else console.log(o.data)})}).fail(function(o){console.log("error"),console.log(o)})}).fail(function(o){console.log("error"),console.log(o)})}else t.text("No new sites available."),t.removeClass("updating-message")})})}}},u(function(){AstraPortfolioAdminPage.init()})}(jQuery);